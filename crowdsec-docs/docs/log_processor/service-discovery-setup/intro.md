---
id: intro
title: Service Discovery & Setup
sidebar_position: 1
---


> Implementation notes & validation
>
> - The CLI can list supported services from your file (`--list-supported-services`). It also validates each datasource by type and errors out on unknown/misplaced fields (e.g., `source` missing; wrong keys for `journalctl`/`docker`; filename with slashes).
>

---

# Use your custom `detect.yaml`
You can provide your file in two ways:

```bash
# Path flag (recommended)
cscli setup detect --detect-config /path/to/detect.yaml

# Or via environment variable
CROWDSEC_SETUP_DETECT_CONFIG=/path/to/detect.yaml cscli setup detect
```

Helpful flags:
- `--yaml` – render the setup plan as YAML (easy to review/edit); default output is JSON.
- `--force <svc>` – pretend detection matched for `<svc>` (repeatable).
- `--ignore <svc>` – drop `<svc>` from the plan even if matched (repeatable).
- `--skip-systemd` – disable systemd‐based detection (useful in containers/chroots).
- `--list-supported-services` – print the service keys present in your file and exit.

**End‑to‑end flow (typical)**
```bash
# 1) build a plan from your rules
cscli setup detect --detect-config ./detect.yaml --yaml > setup.yaml

# 2) validate that plan (optional but recommended)
cscli setup validate ./setup.yaml

# 3) install Hub items + write acquis files
cscli setup install-hub    ./setup.yaml
cscli setup install-acquisition ./setup.yaml --acquis-dir /etc/crowdsec/acquis.d
```

# Examples: override defaults (nginx path, etc.)
If your logs live in non‑standard locations, just encode that in `acquisition_spec`.

```yaml
# detect.yaml
---
detect:
  nginx-custom:
    when:
      - Systemd.UnitInstalled("nginx.service") or len(Path.Glob("/srv/logs/nginx/*.log")) > 0
    hub_spec:
      collections: [crowdsecurity/nginx]
    acquisition_spec:
      filename: nginx.yaml
      datasource:
        source: file
        filenames:
          - /srv/logs/nginx/*.log  # <- your path here
        labels: {type: nginx}
```

You can also define detection purely by process name when systemd isn’t a good signal:
```yaml
  app-by-process:
    when: [ System.ProcessRunning("myappd") ]
    acquisition_spec:
      filename: myappd.yaml
      datasource:
        source: file
        filenames: [ /var/log/myappd/*.log ]
        labels: {type: myappd}
```

---

# Generated acquisition files & coexistence with your own files
When you install acquisition from a setup plan, the CLI writes one file per service as `setup.<name>.yaml` in the acquisition directory (typically `/etc/crowdsec/acquis.d`). The content is **prefixed with a header** that includes a truncated `cscli-checksum` and a comment stating it was generated by `cscli setup`.

- Files carrying a valid `cscli-checksum` are considered **generated** and may be overwritten by future runs.
- Files **without** a valid checksum are treated as **manually edited**; in interactive flows, the CLI shows a colorized diff and asks before overwriting. In unattended flows, the command refuses to proceed if manual files are detected.
- Either way, the safest practice is: **don’t edit generated files**. If you need changes, delete the generated `setup.<name>.yaml` and create your own hand‑managed file instead.

> Tips
> - The actual on‑disk path is computed as `acquis.d/setup.<filename>` where `<filename>` comes from `acquisition_spec.filename`.
> - Use `--acquis-dir` to target a different directory.
> - `--dry-run` prints what would be created without writing files.

---

# Unattended installs with a custom detect file
Package installers often call:

```bash
cscli setup unattended
```

This mode:
- uses the same `--detect-config` and `--acquis-dir` flags;
- never prompts for confirmation;
- will skip itself entirely if `CROWDSEC_SETUP_UNATTENDED_DISABLE` is non‑empty (handy for Ansible/automation);
- installs Hub items and writes `setup.*.yaml` files if and only if there are no conflicting manual acquisitions.

---

# Validation & troubleshooting
- **Validate your setup plan** before writing files:
  ```bash
  cscli setup validate ./setup.yaml
  ```
- Common validation errors (examples):
  - missing `datasource.source`
  - wrong keys for a source type (e.g., `filename` under `journalctl`)
  - missing mandatory fields (e.g., `journalctl_filter` for `journalctl`, `containers/services` for `docker`)
  - `acquisition_spec.filename` contains slashes/backslashes

---

# Reference snippets
- Linux collection detection:
  ```yaml
  detect:
    linux:
      when: [ Host.OS == "linux" ]
      hub_spec:
        collections: [crowdsecurity/linux]
  ```
- MariaDB/MySQL file detection with distro fallbacks:
  ```yaml
  detect:
    mariadb:
      when:
        - Systemd.UnitInstalled("mariadb.service") or Path.Exists("/var/log/mariadb/mariadb.log")
      hub_spec: { collections: [crowdsecurity/mariadb] }
      acquisition_spec:
        filename: mariadb.yaml
        datasource:
          source: file
          labels: {type: mysql}
          filenames:
            - /var/log/mysql/error.log
            - /var/log/mariadb/mariadb.log
  ```

